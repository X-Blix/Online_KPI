{# ç»©æ•ˆå¡«æŠ¥è®°å½•åˆ—è¡¨é¡µé¢ä¸­çš„å•è¡Œè®°å½•æ¨¡æ¿ #}
{% import "components/record.html" as record with context %}
{% import "components/user.html" as user with context %}
{% import "components/problem.html" as problem with context %}
{# è¡Œæ•°æ®å±æ€§ #}
<tr data-rid="{{ rdoc['_id'] }}">
  {# å®¡æ ¸çŠ¶æ€åˆ— #}
  <td class="col--status record-status--border">
    <div style="text-align: center;">
      {# å®¡æ ¸çŠ¶æ€æ˜¾ç¤º #}
      {% if rdoc.kpiStatus == 'pending' %}
        <span class="status--pending" title="å¾…å®¡æ ¸">â³</span>
      {% elif rdoc.kpiStatus == 'approved' %}
        <span class="status--approved" title="å·²é€šè¿‡">âœ…</span>
      {% elif rdoc.kpiStatus == 'rejected' %}
        <span class="status--rejected" title="å·²æ‹’ç»">âŒ</span>
      {% else %}
        <span class="status--pending" title="å¾…å®¡æ ¸">â³</span>
      {% endif %}
      <br>
      <small style="font-size: 0.8em;">
        {% if rdoc.kpiStatus == 'pending' %}å¾…å®¡æ ¸
        {% elif rdoc.kpiStatus == 'approved' %}å·²é€šè¿‡
        {% elif rdoc.kpiStatus == 'rejected' %}å·²æ‹’ç»
        {% else %}å¾…å®¡æ ¸{% endif %}
      </small>
    </div>
  </td>
  
  {# KPIæŒ‡æ ‡åç§°åˆ— #}
  <td class="col--problem col--problem-name">
    {# ç®¡ç†å‘˜æ“ä½œæŒ‰é’® - æ”¹ä¸ºå®¡æ ¸ç›¸å…³æ“ä½œ #}
    {% if handler.user.hasPerm(perm.PERM_REJUDGE) %}
      <form class="form--inline" method="post" action="{{ url('record_detail', rid=rdoc._id, domainId=rdoc.domainId) }}">
        <button type="submit" name="operation" value="rejudge" class="link text-maroon lighter" title="é‡æ–°å®¡æ ¸">
          <span class="icon icon-refresh"></span>
          é‡æ–°å®¡æ ¸
        </button> 
        <button type="submit" name="operation" value="cancel" class="link text-maroon lighter" title="å–æ¶ˆè¯„åˆ†">
          <span class="icon icon-close"></span>
          å–æ¶ˆè¯„åˆ†
        </button> |
      </form>
    {% endif %}
    
    {# KPIæŒ‡æ ‡ä¿¡æ¯æ˜¾ç¤º #}
    {% if pdoc and rdoc.contest %}
      {{ problem.render_problem_title(pdoc, tdoc=tdoc, show_tags=false, show_invisible_flag=false) }}
    {% elif pdoc and (not pdoc.hidden or handler.user.hasPerm(perm.PERM_VIEW_PROBLEM_HIDDEN) or handler.user.own(pdoc)) %}
      {{ problem.render_problem_title(pdoc, show_tags=false) }}
    {% else %}
      <span class="text-gray">[æŒ‡æ ‡å·²åˆ é™¤]</span>
    {% endif %}
    
    {# ç‰¹æ®Šæ ‡è®° - æ”¹ä¸ºç»©æ•ˆç›¸å…³æ ‡è®° #}
    {% if rdoc.evidenceFiles and rdoc.evidenceFiles.length %}
      <span class="text-blue" title="æœ‰è¯æ˜ææ–™">ğŸ“</span>
    {% endif %}
  </td>
  
  {# å¡«æŠ¥äººå‘˜ #}
  <td class="col--submit-by">{{ user.render_inline(udoc, avatar=false, badge=false) }}</td>
  
  {# å®Œæˆæ•°å€¼ #}
  <td class="col--value">
    {% if rdoc.filledValue is not none %}
      <strong>{{ rdoc.filledValue }}</strong>
      {% if pdoc and pdoc.targetValue %}
        <br>
        <small class="text-gray">
          {% set percentage = (rdoc.filledValue / pdoc.targetValue * 100)|round(1) %}
          {{ percentage }}%
        </small>
      {% endif %}
    {% else %}
      <span class="text-gray">-</span>
    {% endif %}
  </td>
  
  {# ç»©æ•ˆå¾—åˆ† #}
  <td class="col--score">
    {% if rdoc.kpiScore is not none %}
      <strong style="font-size: 1.1em; color: #28a745;">{{ rdoc.kpiScore }}</strong>
    {% else %}
      <span class="text-gray">-</span>
    {% endif %}
  </td>
  
  {# å¡«æŠ¥æ—¶é—´ #}
  <td class="col--submit-at">{{ datetimeSpan(rdoc['_id'])|safe }}</td>
  
  {# æ“ä½œåˆ— #}
  <td class="col--actions">
    <a href="{{ url('record_detail', rid=rdoc._id) }}" class="link" title="æŸ¥çœ‹è¯¦æƒ…">
      <span class="icon icon-eye"></span> æŸ¥çœ‹
    </a>
    {% if handler.user._id == rdoc.uid or handler.user.hasPerm(perm.PERM_EDIT_RECORD) %}
      <br>
      {# æ“ä½œæƒé™æ§åˆ¶ #}
      <a href="{{ url('record_detail', rid=rdoc._id) }}?edit=true" class="link text-orange" title="ç¼–è¾‘">
        <span class="icon icon-edit"></span> ç¼–è¾‘
      </a>
    {% endif %}
  </td>
</tr>

<style>
/* çŠ¶æ€é¢œè‰² */
.status--pending { color: #ffc107; font-size: 1.2em; }
.status--approved { color: #28a745; font-size: 1.2em; }
.status--rejected { color: #dc3545; font-size: 1.2em; }

/* åˆ—æ ·å¼ */
.col--value, .col--score, .col--actions {
  text-align: center;
  vertical-align: middle;
}

.col--value strong {
  color: #1890ff;
}

.col--score strong {
  color: #52c41a;
}

.text-gray {
  color: #999;
}

.text-blue {
  color: #1890ff;
}
</style>