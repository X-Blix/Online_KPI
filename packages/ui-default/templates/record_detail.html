{# ç»©æ•ˆå¡«æŠ¥è®°å½•è¯¦æƒ…é¡µé¢çš„ä¸»æ¨¡æ¿æ–‡ä»¶  #}
{% import "components/problem.html" as problem with context %}
{% extends "layout/basic.html" %}
{% block content %}
{% if typeof(rdoc['status']) === 'number' and not rev %}
  {# å¦‚æœè¯„æµ‹è¿˜åœ¨è¿›è¡Œä¸­ä¸”ä¸æ˜¯å†å²ç‰ˆæœ¬ï¼Œå»ºç«‹WebSocketè¿æ¥å®æ—¶æ›´æ–°çŠ¶æ€ #}
  {{ set(UiContext, 'socketUrl', "record-detail-conn?domainId=" + rdoc.domainId + "&rid=" + rdoc._id) }}
{% endif %}
<div class="row">
  {# å·¦æ ï¼Œæ˜¾ç¤ºä¸»è¦ä¿¡æ¯ #}
  <div class="medium-9 columns collapsed">
    {# ç»©æ•ˆå¡«æŠ¥çŠ¶æ€åŒºåŸŸ #}
    {% if typeof(rdoc['status']) === 'number' %}
      {% include 'record_detail_status.html' %}
    {% endif %}
    
    {# ç»©æ•ˆå¡«æŠ¥å†…å®¹åŒºåŸŸ - æ›¿æ¢åŸæ¥çš„ä»£ç æ˜¾ç¤º #}
    {% if rdoc.filledValue is defined or rdoc.filledText %}
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">ğŸ“Š ç»©æ•ˆå¡«æŠ¥è¯¦æƒ…</h1>
        <div class="section__tools">
          {% if rdoc.evidenceFiles and rdoc.evidenceFiles.length %}
          <a class="primary rounded button" href="{{ url('record_download_evidence', rid=rdoc._id) }}">
            <span class="icon icon-download"></span> ä¸‹è½½è¯æ˜ææ–™
          </a>
          {% endif %}
        </div>
      </div>
      <div class="section__body">
        {# ç»©æ•ˆæ•°æ®å±•ç¤º #}
        <div class="row">
          <div class="medium-6 columns">
            <div class="form__item">
              <label class="form__label" style="font-weight: bold; color: #555;">
                å®Œæˆæ•°å€¼
              </label>
              <div class="textbox" style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
                {{ rdoc.filledValue|default('æœªå¡«å†™') }}
                {% if pdoc.targetValue %}
                <small style="color: #666;"> / ç›®æ ‡å€¼: {{ pdoc.targetValue }} {{ pdoc.unit|default('') }}</small>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="medium-6 columns">
            <div class="form__item">
              <label class="form__label" style="font-weight: bold; color: #555;">
                å®¡æ ¸çŠ¶æ€
              </label>
              <div class="textbox" style="background: 
                {% if rdoc.kpiStatus == 'approved' %}#d4edda
                {% elif rdoc.kpiStatus == 'rejected' %}#f8d7da
                {% else %}#fff3cd{% endif %}; 
                padding: 10px; border-radius: 4px; font-weight: bold;">
                {% if rdoc.kpiStatus == 'pending' %}â³ å¾…å®¡æ ¸
                {% elif rdoc.kpiStatus == 'approved' %}âœ… å·²é€šè¿‡
                {% elif rdoc.kpiStatus == 'rejected' %}âŒ å·²æ‹’ç»
                {% else %}ğŸ“ å¾…å®¡æ ¸{% endif %}
              </div>
            </div>
          </div>
        </div>

        {# å®Œæˆæƒ…å†µè¯´æ˜ #}
        {% if rdoc.filledText %}
        <div class="form__item" style="margin-top: 20px;">
          <label class="form__label" style="font-weight: bold; color: #555;">
            å®Œæˆæƒ…å†µè¯´æ˜
          </label>
          <div class="textbox" style="background: #f8f9fa; padding: 15px; border-radius: 4px; min-height: 100px; white-space: pre-wrap;">
            {{ rdoc.filledText }}
          </div>
        </div>
        {% endif %}

        {# ç»©æ•ˆå¾—åˆ† #}
        {% if rdoc.kpiScore is not none %}
        <div class="form__item" style="margin-top: 20px;">
          <label class="form__label" style="font-weight: bold; color: #555;">
            ç»©æ•ˆå¾—åˆ†
          </label>
          <div class="textbox" style="background: #e7f3ff; padding: 10px; border-radius: 4px; font-size: 1.2em; font-weight: bold;">
            {{ rdoc.kpiScore }} åˆ†
          </div>
        </div>
        {% endif %}

        {# ä¸»ç®¡åé¦ˆ #}
        {% if rdoc.feedback %}
        <div class="form__item" style="margin-top: 20px;">
          <label class="form__label" style="font-weight: bold; color: #555;">
            ğŸ’¬ ä¸»ç®¡åé¦ˆ
          </label>
          <div class="textbox" style="background: #fff3cd; padding: 15px; border-radius: 4px; border-left: 4px solid #ffc107;">
            {{ rdoc.feedback }}
          </div>
        </div>
        {% endif %}

        {# è¯æ˜ææ–™ #}
        {% if rdoc.evidenceFiles and rdoc.evidenceFiles.length %}
        <div class="form__item" style="margin-top: 20px;">
          <label class="form__label" style="font-weight: bold; color: #555;">
            ğŸ“ è¯æ˜ææ–™
          </label>
          <div class="textbox" style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
            <ul style="margin: 0; padding-left: 20px;">
              {% for file in rdoc.evidenceFiles %}
              <li>
                <a href="{{ url('record_download_evidence', rid=rdoc._id, filename=file.split('#')[1]) }}" target="_blank">
                  {{ file.split('#')[1] }}
                </a>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {# ä¿ç•™åŸæœ‰çš„ä»£ç æ˜¾ç¤ºåŒºåŸŸï¼ˆéšè—ï¼‰ç”¨äºå…¼å®¹æ€§ #}
    {% if rdoc['code'] or rdoc.files.code %}
    <div class="section" style="display: none;">
      <!-- åŸæœ‰ä»£ç æ˜¾ç¤ºåŒºåŸŸï¼Œéšè—ä½†ä¿ç•™ -->
    </div>
    {% endif %}
  </div>

  {# å³æ ï¼Œæ˜¾ç¤ºä¾§è¾¹æ ä¿¡æ¯ #}
  <div class="medium-3 columns">
    <div class="section side">
      <div class="section__header">
        <h1 class="section__title">{{ _('Information') }}</h1>
      </div>
      
      {# ç®¡ç†å‘˜æ“ä½œèœå• #}
      {% if handler.user.hasPerm(perm.PERM_REJUDGE) and not rdoc.files.hack %}
      <div class="section__body no-padding">
        <ol class="menu">
          <li class="menu__item">
            <form method="post">
              <button type="submit" name="operation" value="rejudge" class="menu__link">
                <span class="icon icon-refresh"></span> é‡æ–°å®¡æ ¸
              </button>
            </form>
          </li>
          <li class="menu__item">
            <form method="post">
              <button type="submit" name="operation" value="cancel" class="menu__link">
                <span class="icon icon-close"></span> å–æ¶ˆè¯„åˆ†
              </button>
            </form>
          </li>
        </ol>
      </div>
      {% endif %}

      <div class="section__body typo no-media">
        <dl class="large horizontal">
          <dt>å¡«æŠ¥äººå‘˜</dt>
          <dd>{{ user.render_inline(udoc, modbadge=false) }}</dd>
          {% if pdoc %}
            <dt>KPIæŒ‡æ ‡</dt>
            <dd>
              {{ problem.render_problem_title(pdoc, tdoc, show_tags=false, show_invisible_flag=false) }}
            </dd>
          {% endif %}
          {% if tdoc %}
            <dt>{{ 'è€ƒæ ¸ä»»åŠ¡' if tdoc.rule == 'homework' else 'è€ƒæ ¸å‘¨æœŸ' }}</dt>
            <dd>
              <a href="{{ url('homework_detail' if tdoc.rule == 'homework' else 'contest_detail', tid=tdoc.docId) }}">{{ tdoc.title }}</a>
            </dd>
          {% endif %}
          <dt>å¡«æŠ¥æ—¶é—´</dt>
          <dd>{{ datetimeSpan(rdoc._id, false)|safe }}</dd>
          {% if rdoc.judgeAt %}
            <dt>å®¡æ ¸æ—¶é—´</dt>
            <dd>{{ datetimeSpan(rdoc.judgeAt, false)|safe }}</dd>
          {% endif %}
          {% if judge_udoc %}
            <dt>å®¡æ ¸äººå‘˜</dt>
            <dd>{{ user.render_inline(judge_udoc, badge=false) }}</dd>
          {% endif %}
        </dl>
        {# è¯„æµ‹æ‘˜è¦ #}
        {% if typeof(rdoc['status']) === 'number' %}
          {% include 'record_detail_summary.html' %}
        {% endif %}
      </div>
    </div>

    {# å†å²ç‰ˆæœ¬ #}
    {% if allRevs|length %}
      <div class="section side">
        <div class="section__header">
          <h1 class="section__title">{{ _('History') }}</h1>
        </div>
        <div class="section__body no-padding">
          <ol class="menu">
            <li class="menu__item">
              <a href="?rev=" {% if not rev %}style="border-color: #4690d0;"{% endif %} class="menu__link">
                {{ _('Latest Version') }}
              </a>
            </li>
            {% for r, rtime in allRevs %}
            <li class="menu__item">
              <a href="?rev={{ r }}" {% if rev and rev.equals(r) %}style="border-color: #4690d0;"{% endif %} class="menu__link">
                {{ datetimeSpan(rtime, false)|safe }}
              </a>
            </li>
            {% endfor %}
          </ol>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<style>
/* æ ·å¼ä¼˜åŒ– */
.form__item {
  margin-bottom: 15px;
}

.form__label {
  display: block;
  margin-bottom: 8px;
  font-weight: bold;
}

.textbox {
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 10px 15px;
}
</style>
{% endblock %}